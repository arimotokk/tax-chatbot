<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Tax Q&A Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 18px 18px 4px 18px;
            display: inline-block;
            max-width: 80%;
            margin-left: auto;
            float: right;
            clear: both;
        }
        
        .answer-block {
            background: white;
            padding: 20px;
            border-radius: 18px 18px 18px 4px;
            max-width: 85%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            clear: both;
        }
        
        .answer {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .sources, .excerpts {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .sources h4, .excerpts h4 {
            color: #667eea;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sources p, .excerpts p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .excerpts p {
            background: #f8f9fa;
            padding: 10px;
            border-left: 3px solid #667eea;
            font-style: italic;
        }
        
        .input-container {
            padding: 30px;
            background: white;
            border-top: 1px solid #e9ecef;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        #question-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #question-input:focus {
            border-color: #667eea;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .upload-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #file-input {
            display: none;
        }
        
        .file-label {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-label:hover {
            background: #5568d3;
        }
        
        .file-name {
            color: #666;
            font-size: 14px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üáØüáµ Japanese Tax Q&A Bot</h1>
            <p>Ask questions about Japanese individual income tax based on official NTA guidelines</p>
        </div>
        
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 30px; border-radius: 4px;">
            <strong>‚ö†Ô∏è DEMO ONLY - NOT FOR PERSONAL USE</strong><br>
            <span style="font-size: 13px; color: #856404;">
                This is a demonstration system. Do not upload documents containing personal information, tax returns, or sensitive data. 
                Only use publicly available NTA documents. This system does not comply with GDPR for personal data processing.
            </span>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="message">
                <div class="answer-block">
                    <div class="answer">
                        üëã Hello! I'm your Japanese tax assistant. Ask me anything about Japanese individual income tax laws and regulations.
                        <br><br>
                        <strong>Example questions:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>What is the tax rate for residents in Japan?</li>
                            <li>How is retirement income taxed?</li>
                            <li>What deductions are available for individual taxpayers?</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching tax documents and generating answer...</p>
        </div>
        
        <div class="input-container">
            <div class="controls">
                <button class="btn btn-secondary" onclick="clearHistory()">Clear History</button>
                <div class="upload-section">
                    <label for="file-input" class="file-label">üìÑ Upload PDF</label>
                    <input type="file" id="file-input" accept=".pdf" onchange="handleFileSelect(event)">
                    <span class="file-name" id="file-name"></span>
                    <button class="btn btn-primary" onclick="uploadDocument()" id="upload-btn" style="display: none;">Upload</button>
                </div>
            </div>
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="question-input" 
                    placeholder="Ask a question about Japanese income tax..."
                    onkeypress="if(event.key === 'Enter') askQuestion()"
                >
                <button class="btn btn-primary" onclick="askQuestion()" id="ask-btn">Ask</button>
            </div>
        </div>
    </div>

    <script>
        async function askQuestion() {
            const input = document.getElementById('question-input');
            const question = input.value.trim();
            
            if (!question) return;
            
            const chatContainer = document.getElementById('chat-container');
            const loading = document.getElementById('loading');
            const askBtn = document.getElementById('ask-btn');
            
            // Add question to chat
            const questionDiv = document.createElement('div');
            questionDiv.className = 'message';
            questionDiv.innerHTML = `<div class="question">${escapeHtml(question)}</div>`;
            chatContainer.appendChild(questionDiv);
            
            // Clear input and disable
            input.value = '';
            input.disabled = true;
            askBtn.disabled = true;
            loading.classList.add('active');
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Add answer to chat
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'message';
                    
                    let html = '<div class="answer-block">';
                    
                    // Add validation badge
                    if (data.validation_status === 'approved') {
                        html += '<div style="display: inline-block; background: #d4edda; color: #155724; padding: 5px 12px; border-radius: 12px; font-size: 12px; margin-bottom: 10px; font-weight: 600;">‚úì Fact-Checked</div>';
                    }
                    
                    html += `<div class="answer">${escapeHtml(data.answer).replace(/\n/g, '<br>')}</div>`;
                    
                    if (data.sources) {
                        html += '<div class="sources"><h4>üìö Sources</h4>';
                        html += `<p>${escapeHtml(data.sources).replace(/\n/g, '<br>')}</p></div>`;
                    }
                    
                    if (data.excerpts) {
                        html += '<div class="excerpts"><h4>üìù Relevant Excerpts</h4>';
                        html += `<p>${escapeHtml(data.excerpts).replace(/\n/g, '<br>')}</p></div>`;
                    }
                    
                    html += '</div>';
                    answerDiv.innerHTML = html;
                    chatContainer.appendChild(answerDiv);
                } else {
                    // Show error
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message';
                    errorDiv.innerHTML = `<div class="error">Error: ${escapeHtml(data.error)}</div>`;
                    chatContainer.appendChild(errorDiv);
                }
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message';
                errorDiv.innerHTML = `<div class="error">Error: ${escapeHtml(error.message)}</div>`;
                chatContainer.appendChild(errorDiv);
            } finally {
                loading.classList.remove('active');
                input.disabled = false;
                askBtn.disabled = false;
                input.focus();
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        async function clearHistory() {
            if (!confirm('Clear conversation history?')) return;
            
            try {
                await fetch('/clear', { method: 'POST' });
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = `
                    <div class="message">
                        <div class="answer-block">
                            <div class="answer">
                                Conversation history cleared. Ask me a new question!
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                alert('Error clearing history: ' + error.message);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        let selectedFile = null;
        
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('file-name').textContent = selectedFile.name;
                document.getElementById('upload-btn').style.display = 'inline-block';
            }
        }
        
        async function uploadDocument() {
            if (!selectedFile) return;
            
            // GDPR compliance check
            const confirmed = confirm(
                '‚ö†Ô∏è GDPR COMPLIANCE WARNING\n\n' +
                'Do NOT upload documents containing:\n' +
                '‚Ä¢ Personal tax returns\n' +
                '‚Ä¢ Names, addresses, or tax IDs\n' +
                '‚Ä¢ Any sensitive personal information\n\n' +
                'Only upload PUBLIC NTA documents.\n\n' +
                'By clicking OK, you confirm this file contains NO personal data.\n\n' +
                'Continue with upload?'
            );
            
            if (!confirmed) {
                // Reset file selection
                document.getElementById('file-input').value = '';
                document.getElementById('file-name').textContent = '';
                document.getElementById('upload-btn').style.display = 'none';
                selectedFile = null;
                return;
            }
            
            const uploadBtn = document.getElementById('upload-btn');
            const fileLabel = document.querySelector('.file-label');
            const chatContainer = document.getElementById('chat-container');
            
            uploadBtn.disabled = true;
            fileLabel.style.opacity = '0.6';
            uploadBtn.textContent = 'Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'message';
                    successDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Successfully uploaded <strong>${selectedFile.name}</strong><br>
                            Added ${data.chunks} text chunks from ${data.pages} pages to the knowledge base.
                        </div>
                    `;
                    chatContainer.appendChild(successDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // Reset file input
                    document.getElementById('file-input').value = '';
                    document.getElementById('file-name').textContent = '';
                    document.getElementById('upload-btn').style.display = 'none';
                    selectedFile = null;
                } else {
                    // Show error
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message';
                    errorDiv.innerHTML = `<div class="error">Upload failed: ${escapeHtml(data.error)}</div>`;
                    chatContainer.appendChild(errorDiv);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message';
                errorDiv.innerHTML = `<div class="error">Upload error: ${escapeHtml(error.message)}</div>`;
                chatContainer.appendChild(errorDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } finally {
                uploadBtn.disabled = false;
                fileLabel.style.opacity = '1';
                uploadBtn.textContent = 'Upload';
            }
        }
    </script>
</body>
</html>
